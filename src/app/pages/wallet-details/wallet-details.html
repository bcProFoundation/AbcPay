<ion-header class="bp-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button icon="chevron-back-outline" defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>
      <div [reveal-at-scroll-pos]="(expandableHeader.headerHeight + 200)" [scrollArea]="scrollArea">
        {{wallet?.name}}
      </div>
    </ion-title>
  </ion-toolbar>
</ion-header>
<ion-content scrollEvents="true" forceOverflow="false" #scrollArea [fixed-scroll-bg-color]="backgroundColor">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)" pullMin="90" pullMax="160">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <div class="wrapper" [ngClass]="{'grid-wrapper': shouldShowZeroState()}">
    <expandable-header class="balance-card" [scrollArea]="scrollArea" #expandableHeader>
      <expandable-header-primary class="balance-header">

        <div *ngIf="wallet?.network == 'testnet'" class="top-notification warning">
          <a class="energized"
            (click)="openExternalLink('https://support.bitpay.com/hc/en-us/articles/360004102011-What-is-testnet-How-do-I-avoid-testnet-Bitcoin-scams-')">
            {{'Learn more about testnet blockchain' | translate}}
            <ion-icon name="chevron-forward"></ion-icon>
          </a>
        </div>

        <div *ngIf="lowUtxosWarning && wallet?.network == 'livenet'" class="top-notification warning">
          <a class="energized" (click)="openAddresses()">
            {{'Spending this balance will need significant Bitcoin network fees'|translate}}
            <ion-icon name="chevron-forward"></ion-icon>
          </a>
        </div>

        <div class="wallet-card" [ngClass]="{ 
          'bg-bch': wallet.coin == 'bch',
          'bg-xec': wallet.coin == 'xec',
          'bg-xpi': wallet.coin == 'xpi',
          'bg-doge': wallet.coin == 'doge',
          'bg-ltc': wallet.coin == 'ltc'
          }">
          <div class="wallet-card-header">
            <div class="wallet-icon">
              <img src="assets/img/currencies/{{wallet.coin}}.svg" alt="">
              <div class="wallet-name">
                <p class="name">{{wallet?.name}}</p> 
                <p copy-to-clipboard="{{ address }}"> {{(address | slice:0:10) +'...'+ (address | slice:-12)}} 
                  <ion-icon name="copy-outline"></ion-icon>
                </p>
              </div>
            </div>
            <div class="wallet-setting" (click)="openWalletSettings(wallet.id)">
              <img src="assets/img/wallet-details/wallet-setting-{{currentTheme}}.svg" alt="">
            </div>
          </div>

          <div class="balance-content">
            <div (tap)="updateAll(true)"
              *ngIf="!wallet?.scanning && !walletNotRegistered && (wallet?.cachedStatus || wallet?.lastKnownBalance)">
              <div class="balance-str">
                <ion-icon class="eye" [name]="wallet?.balanceHidden ? 'eye-outline' : 'eye-off-outline'" (click)="toggleBalance()"></ion-icon>
                <balance-to-show *ngIf="!wallet?.balanceHidden" [balance]="getBalance()"></balance-to-show>
                <div *ngIf="wallet?.balanceHidden">******</div>
                <img *ngIf="wallet.coin === 'xrp'" width="21" (click)="openBalanceDetails()"
                  src="assets/img/icon-info-blue.svg">
              </div>
              <div class="balance-alt-str" *ngIf="wallet?.cachedStatus && wallet?.cachedStatus.totalBalanceAlternative && !wallet?.balanceHidden">
                ~ {{getAlternativeBalance()}} {{wallet?.cachedStatus.alternativeIsoCode}}
              </div>
              <div class="balance-alt-str" *ngIf="wallet?.balanceHidden">
                ******
              </div>
            </div>
  
          </div>
        </div>

        <div class="balance-scanning" *ngIf="!updateStatusError && wallet?.scanning">
          <div>
            <span class="title" translate>[Scanning Funds]</span>
            <div translate>
              Please wait...
            </div>
          </div>
        </div>

        <div class="balance-spendable" (click)="openBalanceDetails()"
          *ngIf="!wallet?.balanceHidden && !wallet?.scanning && !updateStatusError && showBalanceButton">
          <span>{{ 'Available:' | translate}}</span>
          &nbsp;
          <strong>
            {{wallet?.cachedStatus.spendableBalanceStr}}
          </strong>
          &nbsp;
          <ion-icon name="help-circle"></ion-icon>
        </div>

        <div class="balance-error" *ngIf="updateStatusError">
          <div>
            <span ion-text color="warning">{{wallet?.error}}</span>
          </div>
        </div>

        <div class="balance-error" *ngIf="walletNotRegistered">
          <div translate>
            This wallet is not registered at the given AbcPros Wallet Service (AWS). As an advice, you could delete the
            key, under settings and selecting the specific key, and then use the Backup to import the wallet again
            (under Home > Wallet Tab).
          </div>
        </div>
      </expandable-header-primary>
      <expandable-header-footer>
        <div class="action-buttons" [ngClass]="{'two-actions': !showBuyCrypto && !showExchangeCrypto}">

          <div class="action-btn receive-btn" (click)="goToReceivePage()">
            <ion-button expand="block">
              <ion-icon slot="start" name="arrow-down-outline"></ion-icon>
              {{ 'Receive' | translate }}
            </ion-button>
          </div>

          <div class="action-btn send-btn" (click)="goToSendPage()">
            <ion-button expand="block">
              <ion-icon slot="start" name="arrow-up-outline"></ion-icon>
              {{ 'Send' | translate }}
            </ion-button>
          </div>

        </div>
        <div *ngIf="isShowDonationBtn" class="donate-card">
          <div class="donate-title">
            {{ 'Support Lotus with the Donation Program' | translate}}
          </div>
          
          <div class="donate-butons">
            <ion-button class="about-us-btn" fill="clear" (click)="openLink('https://givelotus.org')">
              {{ 'About us' | translate}}
            </ion-button>
            <ion-button class="donate-btn" (click)="handleDonation()">
              {{ 'Donate' | translate}}
            </ion-button>
          </div>
          
        </div>
      </expandable-header-footer>
    </expandable-header>
    <ion-list lines="none" *ngIf="wallet && wallet?.isComplete() && !walletNotRegistered && txps && txps[0]"
      class="tx-history">
      <ion-item-divider *ngIf="wallet?.incorrectDerivation">
        <ion-label>
          <span translate>
            WARNING: Key derivation is not working on this device/wallet?. Actions cannot be performed on this wallet?.
          </span>
        </ion-label>
      </ion-item-divider>
      <ion-item-divider class="tx-history-header tx-history-header--large">
        <ion-label>
          <span *ngIf="requiresMultipleSignatures" translate>Pending Proposals</span>
          <span *ngIf="!requiresMultipleSignatures" translate>Unsent transactions</span>
        </ion-label>
        <ion-badge class="txps-badge" *ngIf="txps.length > 0" (click)="openProposalsNotificationsPage()"
          color="primary">{{txps.length}}</ion-badge>
      </ion-item-divider>
      <div *ngFor="let txp of txpsPending;  let i=index">
        <page-txp *ngIf="i<=2" [tx]="txp" [addressbook]="addressbook"></page-txp>
      </div>
      <ion-item *ngIf="wallet?.cachedStatus && wallet?.cachedStatus.lockedBalanceSat" class="locked-balance"
        (click)="openBalanceDetails()">
        <span translate>Total Locked Balance</span>
        <ion-note slot="end">
          <span class="total-locked-amount">{{wallet?.cachedStatus.lockedBalanceStr}}</span>
          <div class="total-alt-locked-amount">{{wallet?.cachedStatus.lockedBalanceAlternative}}
            {{wallet?.cachedStatus.alternativeIsoCode}}</div>
        </ion-note>
      </ion-item>
    </ion-list>

    <!-- Transactions -->


    <div class="prompt-user activity-fix white-card" *ngIf="shouldShowZeroState()">
      <div class="title-icon larger-icon" *ngIf="!wallet?.credentials.multisigEthInfo">
        <img
          *ngIf="wallet.coin === 'xrp' && wallet.cachedStatus && !wallet.cachedStatus.lockedBalanceSat; else ghostTongue"
          width="42" src="assets/img/icon-warning-circled.svg" />
        <ng-template #ghostTongue>
          <img *ngIf="wallet.coin !== 'doge' && wallet.coin !== 'xpi'" src="assets/img/ghost-tongue-out.svg">
          <img *ngIf="wallet.coin === 'xpi'"
            [src]="selectedTheme === 'dark' ? 'assets/img/frog-dark.svg' : 'assets/img/frog-light.svg'">
          <img *ngIf="wallet.coin === 'doge'" src="assets/img/sad-doge.svg">
        </ng-template>
      </div>
      <div class="title-info">
        <span translate
          *ngIf="wallet?.coin === 'xrp' && wallet?.cachedStatus && !wallet?.cachedStatus.lockedBalanceSat; else ghostTown">XRP
          Minimum Balance</span>
        <ng-template #ghostTown>
          <span translate
            *ngIf="!wallet?.credentials.multisigEthInfo && wallet.coin !== 'doge' && wallet.coin !== 'xpi'">It's a ghost
            town in here</span>
          <span translate *ngIf="!wallet?.credentials.multisigEthInfo && wallet.coin === 'xpi'">It's an empty pond
            here</span>
          <span translate *ngIf="!wallet?.credentials.multisigEthInfo && wallet.coin === 'doge' ">A dog without funds is
            a sad dog</span>
          <span translate *ngIf="wallet?.credentials.multisigEthInfo">Join more Copayers</span>
        </ng-template>
      </div>
      <div class="subtitle-info">
        <span translate
          *ngIf="wallet?.coin === 'xrp' && wallet?.cachedStatus && !wallet?.cachedStatus.lockedBalanceSat; else noFunds">
          The XRP ledger requires that all wallets maintain a minimum balance of 20 XRP. This non-refundable 20 XRP will
          remain permanently locked in your wallet. Please first deposit no less than 20 XRP to activate your wallet.
        </span>
        <ng-template #noFunds>
          <span translate *ngIf="!wallet?.credentials.multisigEthInfo">
            If you have funds stored on a website then you should move them into a secure wallet... like this one!
          </span>
          <span translate *ngIf="wallet?.credentials.multisigEthInfo">
            Share this invitation with the Copayers who join this wallet.
          </span>
        </ng-template>
      </div>
      <div class="qr-container" *ngIf="wallet?.credentials.multisigEthInfo">
        <div *ngIf="wallet?.credentials.multisigEthInfo.multisigContractAddress" class="card qr-card"
          copy-to-clipboard="{{ wallet.credentials.multisigEthInfo.multisigContractAddress }}">
          <ngx-qrcode hide-toast="true" value="{{ wallet.credentials.multisigEthInfo.multisigContractAddress }}"
            cssClass="aclass" [errorCorrectionLevel]="typeErrorQr.MEDIUM"></ngx-qrcode>
        </div>
      </div>
    </div>

    <div class="middle-message white-card" *ngIf="updateTxHistoryError" translate>
      Could not update transaction history
    </div>

    <div class="middle-message" *ngIf="updatingTxHistory && (!history[0] || updatingTxHistoryProgress>4)">
      <span translate>Updating transaction history. Please stand by.</span>
      <br>
      <span translate *ngIf="updatingTxHistoryProgress>4">{{updatingTxHistoryProgress}} transactions downloaded</span>
    </div>

    <div *ngIf="history && history[0]" class="header-transaction">
      Transaction History
    </div>
    <ion-list *ngIf="history && history[0]" class="tx-history">
      <ion-item-group *ngFor="let group of groupedHistory; trackBy: trackByFn; let i = index;">

        <ion-item-divider (click)="viewOnBlockchain()" sticky class="tx-history-header">
          <ion-label>
            <span *ngIf="isDateInCurrentMonth(getDate(group[0].time))">{{ 'Recent' | translate }} </span>
            <span *ngIf="!isDateInCurrentMonth(getDate(group[0].time))">{{getDate(group[0].time) |
              amDateFormat:'MMMM'}}</span>
          </ion-label>
        </ion-item-divider>

        <div class="item-wrapper" *ngFor="let tx of group; trackBy: trackByFn; let i = index">

          <ion-item button detail-icon="true" (click)="itemTapped(tx)"
            [ngClass]="{'warning-background': canSpeedUpTx(tx), 'danger-background': tx.hasUnconfirmedInputs || tx.isRBF}">
            <div class="item-img" slot="start">
              <div *ngIf="tx.confirmations <= 0">
                <img src="assets/img/tx-action/icon-pending-{{currentTheme}}.svg" width="40">
              </div>
              <div *ngIf="tx.confirmations > 0">
                <span *ngIf="tx.customData && tx.customData.service">
                  <img class="icon-services" src="assets/img/shapeshift/icon-shapeshift.svg"
                    *ngIf="tx.customData.service == 'shapeshift'" width="40">
                  <img class="icon-services" src="assets/img/exchange-crypto/changelly-icon.svg"
                    *ngIf="tx.customData.service == 'changelly'" width="40">
                  <img-loader class="icon-services" *ngIf="tx.customData.service === 'amazon'"
                    src="https://bitpay.com/gift-cards/assets/amazoncom/icon.svg" width="40"
                    fallbackUrl="assets/img/gift-cards/gift-cards-icon.svg"></img-loader>
                  <img-loader class="icon-services" *ngIf="tx.customData.service === 'mercadolibre'"
                    src="https://bitpay.com/gift-cards/assets/mercadolivre/icon.svg" width="40"
                    fallbackUrl="assets/img/gift-cards/gift-cards-icon.svg"></img-loader>
                  <img-loader class="icon-services" *ngIf="tx.customData.service === 'coinbase'"
                    src="assets/img/coinbase/coinbase-icon.png" width="40"
                    fallbackUrl="assets/img/gift-cards/gift-cards-icon.svg"></img-loader>
                  <img class="icon-services" src="assets/img/bitpay-card/icon-bitpay.svg"
                    *ngIf="tx.customData.service == 'debitcard'" width="40">
                </span>
                <span *ngIf="tx.customData && tx.customData.toWalletName && !tx.customData.service">
                  <img src="assets/img/tx-action/icon-sent-{{currentTheme}}.svg" *ngIf="tx.action == 'sent'"
                    width="40">
                </span>
                <span
                  *ngIf="!tx.customData || (tx.customData && !tx.customData.service && !tx.customData.toWalletName)">
                  <img src="assets/img/tx-action/icon-sent-{{currentTheme}}.svg" *ngIf="tx.action == 'sent'" width="40">
                </span>
                <span>
                  <img src="assets/img/tx-action/icon-received-{{currentTheme}}.svg" *ngIf="tx.action == 'received'" width="40">
                  <img src="assets/img/tx-action/icon-moved.svg" *ngIf="tx.action == 'moved'" width="40">
                  <img src="assets/img/tx-action/icon-mined-{{currentTheme}}.svg" *ngIf="tx.action == 'mined'" width="40">
                  <img src="assets/img/tx-action/icon-pending-{{currentTheme}}.svg" *ngIf="tx.action == 'immature'" width="40">
                </span>
              </div>
            </div>

            <div class="action" *ngIf="tx.confirmations <= 0 && !(tx.amount === 0 && wallet?.coin === 'eth')">
              <span
                *ngIf="(tx.action == 'sent') && !(addressbook && tx.outputs[0] && getContactName(tx.outputs[0].address))">{{'Sending'
                | translate}}
              </span>
              <span
                *ngIf="(tx.action == 'moved') && !(addressbook && tx.outputs[0] && getContactName(tx.outputs[0].address))">{{'Moving'
                | translate}}</span>
              <span
                *ngIf="(tx.action == 'sent' || tx.action == 'moved') && (addressbook && tx.outputs[0] && getContactName(tx.outputs[0].address))">{{getContactName(tx.outputs[0].address)}}</span>
              <span *ngIf="tx.action == 'received'">{{'Receiving' | translate}}</span>
              <br>
              <div class="date">
                <span *ngIf="tx.time && createdWithinPastDay(tx.time * 1000)">{{converDate(tx.time * 1000) |
                  amTimeAgo}}</span>
                <span *ngIf="tx.time && !createdWithinPastDay(tx.time * 1000)">{{tx.time * 1000 | amDateFormat:'MMM
                  D, YYYY'}}</span>
              </div>
            </div>

            <div class="action" *ngIf="tx.action == 'immature'">
              <span >{{'Immature'| translate}}</span>
              <br>
              <div class="date">
                <span *ngIf="tx.time && createdWithinPastDay(tx.time * 1000)">{{converDate(tx.time * 1000) |
                  amTimeAgo}}</span>
                <span *ngIf="tx.time && !createdWithinPastDay(tx.time * 1000)">{{tx.time * 1000 | amDateFormat:'MMM
                  D, YYYY'}}</span>
              </div>
            </div>
            <div class="action" *ngIf="tx.action == 'mined'">
              <span>{{'Mined'| translate}}</span>
              <br>
              <div class="date">
                <span *ngIf="tx.time && createdWithinPastDay(tx.time * 1000)">{{converDate(tx.time * 1000) |
                  amTimeAgo}}</span>
                <span *ngIf="tx.time && !createdWithinPastDay(tx.time * 1000)">{{tx.time * 1000 | amDateFormat:'MMM
                  D, YYYY'}}</span>
              </div>
            </div>

            <div class="action" *ngIf="tx.confirmations > 0 && tx.action == 'received'">
              <span
                *ngIf="(!tx.note || (tx.note && !tx.note.body)) && (!addressbook || !tx.outputs[0] || !getContactName(tx.outputs[0].address))">{{'Received'
                | translate}}</span>
              <span *ngIf="tx.note && tx.note.body != ''">{{tx.note.body}}</span>
              <span
                *ngIf="(!tx.note || (tx.note && !tx.note.body)) && addressbook && tx.outputs[0] && getContactName(tx.outputs[0].address)">
                {{getContactName(tx.outputs[0].address)}}
              </span>
              <br>
              <div class="date">
                <span *ngIf="tx.time && createdWithinPastDay(tx.time * 1000)">{{converDate(tx.time * 1000) |
                  amTimeAgo}}</span>
                <span *ngIf="tx.time && !createdWithinPastDay(tx.time * 1000)">{{tx.time * 1000 | amDateFormat:'MMM
                  D, YYYY'}}</span>
              </div>
            </div>

            <div class="action"
              *ngIf="tx.confirmations > 0 && tx.action == 'sent' && !(tx.amount === 0 && wallet?.coin === 'eth')">
              <span
                *ngIf="(tx.message && (tx.note && !tx.note.body)) && (!addressbook || !tx.outputs[0] || !getContactName(tx.outputs[0].address)) && (!tx.customData || !tx.customData.toWalletName)"
                translate>Sent</span>
              <span
                *ngIf="!tx.message && (!tx.note || (tx.note && !tx.note.body)) && (!addressbook || !tx.outputs[0] || !getContactName(tx.outputs[0].address)) && (!tx.customData || !tx.customData.toWalletName)">{{'Sent'
                | translate}}</span>
              <span
                *ngIf="!tx.message && (!tx.note || (tx.note && !tx.note.body)) && (!addressbook || !tx.outputs[0] || !getContactName(tx.outputs[0].address)) && (tx.customData && tx.customData.toWalletName)">
                {{ 'Sent to {walletName}' | translate: {walletName: tx.customData.toWalletName} }}
              </span>
              <span *ngIf="!tx.note && tx.message">{{tx.message}}</span>
              <span *ngIf="tx.note && tx.note.body != ''">{{tx.note.body}}</span>
              <span *ngIf="!tx.message && addressbook && tx.outputs[0] && getContactName(tx.outputs[0].address)">
                {{getContactName(tx.outputs[0].address)}}
              </span>
              <br>
              <div class="date">
                <span *ngIf="tx.time && createdWithinPastDay(tx.time * 1000)">{{converDate(tx.time * 1000) |
                  amTimeAgo}}</span>
                <span *ngIf="tx.time && !createdWithinPastDay(tx.time * 1000)">{{tx.time * 1000 | amDateFormat:'MMM
                  D, YYYY'}}</span>
              </div>
            </div>

            <div class="action" *ngIf="tx.amount === 0 && wallet?.coin === 'eth'">
              <span>{{'Interaction with contract' | translate}}</span>
              <br>
              <div class="date">
                <span *ngIf="tx.time && createdWithinPastDay(tx.time * 1000)">{{converDate(tx.time * 1000) |
                  amTimeAgo}}</span>
                <span *ngIf="tx.time && !createdWithinPastDay(tx.time * 1000)">{{tx.time * 1000 | amDateFormat:'MMM
                  D, YYYY'}}</span>
              </div>
            </div>

            <div class="action" *ngIf="tx.confirmations > 0 && tx.action == 'moved'">
              <span *ngIf="(tx.message && (tx.note && !tx.note.body))" translate>Sent to self</span>
              <span *ngIf="((!tx.note || (tx.note && !tx.note.body)) && !tx.message)" translate>Sent to self</span>
              <span *ngIf="!tx.note && tx.message">{{tx.message}}</span>
              <span *ngIf="tx.note && tx.note.body != ''">{{tx.note.body}}</span>
              <br>
              <div class="date">
                <span *ngIf="tx.time && createdWithinPastDay(tx.time * 1000)">{{converDate(tx.time * 1000) |
                  amTimeAgo}}</span>
                <span *ngIf="tx.time && !createdWithinPastDay(tx.time * 1000)">{{tx.time * 1000 | amDateFormat:'MMM
                  D, YYYY'}}</span>
              </div>
            </div>

            <div class="action" *ngIf="tx.confirmations > 0 && tx.action == 'invalid'">
              <span class="assertive" *ngIf="!tx.message && !tx.note" translate>Invalid</span>
              <br>
              <div class="date">
                <span *ngIf="tx.time && createdWithinPastDay(tx.time * 1000)">{{converDate(tx.time * 1000) |
                  amTimeAgo}}</span>
                <span *ngIf="tx.time && !createdWithinPastDay(tx.time * 1000)">{{tx.time * 1000 | amDateFormat:'MMM
                  D, YYYY'}}</span>
              </div>
            </div>

            <ion-note slot="end" class="ion-text-end">
              <div class="amount">
                <span [ngClass]="{'received': tx.action == 'received' || tx.action == 'mined', 'sent' : tx.action == 'sent'}" *ngIf="tx.action != 'invalid' && !(tx.amount === 0 && wallet?.coin === 'eth')">{{tx.amount |
                      satToUnit: wallet?.coin}}</span>
                <span *ngIf="tx.amount === 0 && wallet?.coin === 'eth'">{{tx.fees | satToUnit: wallet?.coin}}</span>
                <span class="double-spend" *ngIf="tx.action == 'invalid'" translate>(possible double spend)</span>
              </div>
            </ion-note>
          </ion-item>
        </div>
      </ion-item-group>
    </ion-list>

    <ion-infinite-scroll (ionInfinite)="loadHistory($event)" *ngIf="!shouldShowZeroState()">
      <ion-infinite-scroll-content></ion-infinite-scroll-content>
    </ion-infinite-scroll>
  </div>
</ion-content>